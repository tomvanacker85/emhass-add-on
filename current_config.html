<!-- Configuration page html -->
<!DOCTYPE html>
<html class="adaptive">

<head>
  <title>EMHASS: Energy Management Optimization for Home Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="static/style.css?version=1">
  <link rel="icon" type="image/x-icon" href="static/img/emhass_logo_short.svg">
  <script src="static/configuration_script.js"></script>
</head>

<body style="margin: auto; align-items:center; text-align:center;">

  <div>
    <!-- Icons by feather https://github.com/feathericons/feather -->
    <div id="top-links">
      <!-- index page  -->
      <a href="index" title="Home" style="margin-right: 12px; cursor: pointer; z-index: 1">
        <svg class="feather">
          <use class="feather" href="static/img/feather-sprite.svg#home" />
        </svg>
      </a>
      <a href="https://emhass.readthedocs.io/en/latest/">
        <svg class="feather" title="EMHASS Docs" style="margin-right: 12px;" ;>
          <use class="feather" href="static/img/feather-sprite.svg#book" />
        </svg>
      </a>
      <a href="https://github.com/davidusb-geek/emhass" target="_blank" rel="noopener noreferrer">
        <svg class="feather" title="EMHASS Git repo" style="margin-right: 0px;">
          <use class="feather" href="static/img/feather-sprite.svg#git-branch" />
        </svg>
      </a>
    </div>

    <!-- Title -->
    <img src="static/img/emhass_icon.png" alt="">
    <h2>EMHASS: Energy Management Optimization for Home Assistant</h2>
  </div>
  <div class="header-footer">
    <h4>Configuration:</h4>
    <a id="json-toggle" title="List and Box view toggle">
      <svg id="json" class="feather" class="header-footer-button">
        <use class="feather" href="static/img/feather-sprite.svg#code" />
      </svg>
    </a>
  </div>

  <!-- parameter list/box elements section -->
  <div id=configuration-container>
  </div>
  <!-- configuration buttons (defaults, save, yaml) -->
  <div class="save_button header-footer">
    <button style="margin-right: 5px;" type="button" id="yaml" title="Convert yaml to json" class="">YAML</button>
    <button type="button" id="defaults" title="Restore to default parameter values" class="">Defaults</button>
    <button type="button" id="save" title="Save Config to EMHASS" class="">Save</button>
    <div class="loading-div"> <!-- dynamic tick/cross element -->
      <div id=loader></div> 
    </div>
  </div>
  <!-- alert box -->
  <div style="display: none;" id="alert" class="alert">
    <div>
      <span onclick="this.parentElement.parentElement.style.display='none';">&times;</span>
      <p id="alert-text"></p>
    </div>
  </div>
  <footer class="footer">
    <p style="margin-top:10px; text-align:center;">&copy; MIT License | Copyright (c) 2021-2025 David
      HERNANDEZ</p>
  </footer>
  </div>
</body>

<script>
// EV Configuration Handler
document.addEventListener("DOMContentLoaded", function() {
    console.log("EV Configuration loaded");
    
    // Load existing EV configuration if available
    function loadEVConfig() {
        try {
            if (window.configData && window.configData.params && window.configData.params.ev_conf) {
                const evConf = window.configData.params.ev_conf;
                if (document.getElementById("number_of_ev_loads")) {
                    document.getElementById("number_of_ev_loads").value = evConf.number_of_ev_loads || 1;
                    document.getElementById("ev_battery_capacity").value = JSON.stringify(evConf.ev_battery_capacity || [75000]);
                    document.getElementById("ev_charging_efficiency").value = JSON.stringify(evConf.ev_charging_efficiency || [0.9]);
                    document.getElementById("ev_nominal_charging_power").value = JSON.stringify(evConf.ev_nominal_charging_power || [11000]);
                    document.getElementById("ev_minimum_charging_power").value = JSON.stringify(evConf.ev_minimum_charging_power || [1380]);
                    document.getElementById("ev_consumption_efficiency").value = JSON.stringify(evConf.ev_consumption_efficiency || [0.2]);
                    console.log("EV configuration loaded from existing data");
                }
            }
        } catch(e) {
            console.log("Using default EV configuration");
        }
    }
    
    // Hook into form submission
    const forms = document.querySelectorAll("form");
    forms.forEach(function(form) {
        form.addEventListener("submit", function() {
            try {
                const evConfig = {
                    number_of_ev_loads: parseInt(document.getElementById("number_of_ev_loads")?.value || "1"),
                    ev_battery_capacity: JSON.parse(document.getElementById("ev_battery_capacity")?.value || "[75000]"),
                    ev_charging_efficiency: JSON.parse(document.getElementById("ev_charging_efficiency")?.value || "[0.9]"),
                    ev_nominal_charging_power: JSON.parse(document.getElementById("ev_nominal_charging_power")?.value || "[11000]"),
                    ev_minimum_charging_power: JSON.parse(document.getElementById("ev_minimum_charging_power")?.value || "[1380]"),
                    ev_consumption_efficiency: JSON.parse(document.getElementById("ev_consumption_efficiency")?.value || "[0.2]")
                };
                
                if (window.configData && window.configData.params) {
                    window.configData.params.ev_conf = evConfig;
                }
                
                console.log("EV Configuration collected:", evConfig);
            } catch(e) {
                console.error("Error collecting EV configuration:", e);
            }
        });
    });
    
    // Load existing configuration
    setTimeout(loadEVConfig, 1000);
});
</script>

<!-- EV Configuration Section -->
<div class="form-group" id="ev-config-section" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); border: 2px solid #4a90e2; border-radius: 12px; padding: 20px; margin: 20px 0;">
    <h3 style="color: #2c5aa0; border-bottom: 2px solid #4a90e2; padding-bottom: 10px; margin-bottom: 15px;">ðŸš— Electric Vehicle Configuration</h3>
    
    <div style="background: rgba(74, 144, 226, 0.1); padding: 12px; border-radius: 6px; margin-bottom: 20px; font-style: italic; color: #2c5aa0;">
        Configure EV charging parameters and consumption patterns for optimal charging schedule optimization.
    </div>
    
    <div style="display: grid; gap: 15px;">
        <div>
            <label for="number_of_ev_loads" style="display: block; font-weight: bold; margin-bottom: 5px;">Number of EV Loads:</label>
            <input type="number" id="number_of_ev_loads" name="number_of_ev_loads" min="0" max="5" value="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Number of electric vehicles to optimize (0 = disabled)</small>
        </div>
        
        <div>
            <label for="ev_battery_capacity" style="display: block; font-weight: bold; margin-bottom: 5px;">Battery Capacity (Wh):</label>
            <input type="text" id="ev_battery_capacity" name="ev_battery_capacity" value="[75000]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Battery capacity in Wh for each EV (e.g., [75000] for 75 kWh)</small>
        </div>
        
        <div>
            <label for="ev_charging_efficiency" style="display: block; font-weight: bold; margin-bottom: 5px;">Charging Efficiency:</label>
            <input type="text" id="ev_charging_efficiency" name="ev_charging_efficiency" value="[0.9]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Charging efficiency (0-1) for each EV (e.g., [0.9] for 90%)</small>
        </div>
        
        <div>
            <label for="ev_nominal_charging_power" style="display: block; font-weight: bold; margin-bottom: 5px;">Nominal Charging Power (W):</label>
            <input type="text" id="ev_nominal_charging_power" name="ev_nominal_charging_power" value="[11000]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Maximum charging power in W for each EV (e.g., [11000] for 11 kW)</small>
        </div>
        
        <div>
            <label for="ev_minimum_charging_power" style="display: block; font-weight: bold; margin-bottom: 5px;">Minimum Charging Power (W):</label>
            <input type="text" id="ev_minimum_charging_power" name="ev_minimum_charging_power" value="[1380]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Minimum charging power in W for each EV (e.g., [1380])</small>
        </div>
        
        <div>
            <label for="ev_consumption_efficiency" style="display: block; font-weight: bold; margin-bottom: 5px;">Consumption Efficiency (kWh/km):</label>
            <input type="text" id="ev_consumption_efficiency" name="ev_consumption_efficiency" value="[0.2]" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Energy consumption in kWh per km (e.g., [0.2] for 20 kWh/100km)</small>
        </div>
    </div>
    
    <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-top: 20px;">
        <h4 style="margin-top: 0; color: #495057;">ðŸ’¡ EV Configuration Tips:</h4>
        <ul style="margin-bottom: 0; padding-left: 20px;">
            <li><strong>Battery Capacity:</strong> Use Wh units (e.g., 75 kWh = 75000 Wh)</li>
            <li><strong>Charging Power:</strong> Check your charger specifications (3.7kW, 7.4kW, 11kW, 22kW)</li>
            <li><strong>Consumption:</strong> Typical values: 0.15-0.25 kWh/km depending on EV model</li>
            <li><strong>Multiple EVs:</strong> Use arrays like [75000, 60000] for two different EVs</li>
        </ul>
    </div>
</div>
<!-- End EV Configuration Section -->

</html>